// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model dept {
  id        String   @id  @default(uuid())
  name      String

  users     user[]  @relation("UsersUnderDept")
  courses   course[] @relation("CoursesUnderDept")
  students  student[] @relation("StudentsUnderDept")
  programs  program[] @relation("ProgramsUnderDept")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model program {
  id        String   @id  @default(uuid())
  name      String

  programSpecificCourses course[] @relation("ProgramSpecificCourses")
  reports   report[]

  deptId    String
  dept      dept     @relation("ProgramsUnderDept", fields: [deptId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model user {
  id        String   @id  @default(uuid())
  email     String   @unique
  password  String
  name      String
  phoneNumber String
  role      Int

  cordinatedCourses course[] @relation("CourseCordinated")
  sections  section[] @relation("SectionsTaught")

  deptId    String
  dept      dept     @relation("UsersUnderDept", fields: [deptId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model student {
  id        String   @id  @default(uuid())
  regNo     String   @unique
  name      String
  phoneNumber String
  email     String  @unique
  batch     String

  sections section[] @relation("SectionsAssigned")
  marks    marking[] @relation("MarksObtainedByStudent")

  deptId    String
  dept      dept     @relation("StudentsUnderDept", fields: [deptId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model course {
  id        String   @id  @default(uuid())
  name      String
  type      String

  sections  section[] @relation("SectionsUnderCourse")
  tests     test[]
  reports   report[]

  deptId    String
  cordinatorId String
  programId String?
  program   program? @relation("ProgramSpecificCourses", fields: [programId], references: [id])
  dept      dept @relation("CoursesUnderDept", fields: [deptId], references: [id])
  cordinator user @relation("CourseCordinated", fields: [cordinatorId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model section {
  id        String   @id  @default(uuid())
  roomNo    String
  batch     String
  semester  Int

  students  student[] @relation("SectionsAssigned")
  reports   report[]
  markings  marking[] @relation("MarksObtainedByStudent")

  courseId  String
  userId    String
  course    course @relation("SectionsUnderCourse", fields: [courseId], references: [id]) 
  user      user     @relation("SectionsTaught", fields: [userId], references: [id])
  @@unique([courseId, userId])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model test {
  id        String   @id  @default(uuid())
  name      String
  requiredPercentage Float
  maxMarks  Int

  parts     part[]
  reports   report[]

  courseId  String
  course    course @relation(fields: [courseId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model part {
  id        String   @id  @default(uuid())
  name      String
  maxQuestions Int
  requiredQuestions Int
  maxMarks  Int

  questions question[]  @relation("TestParts")

  testId    String
  test      test @relation(fields: [testId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model question {
  id        String   @id  @default(uuid())
  name      String
  objective Int
  maxMarks  Int
  subparts  Json?

  marks     marking[] @relation("MarksObtainedOnQuestion")
  questionReports questionReport[] @relation("QuestionReport")

  partId    String
  part      part @relation("TestParts", fields: [partId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model marking {
  id        String   @id  @default(uuid())
  totalMarksObtained     Int
  subpartMarksObtained Json?

  studentId     String
  questionId    String
  sectionId     String
  student   student @relation("MarksObtainedByStudent", fields: [studentId], references: [id])
  section   section @relation("MarksObtainedByStudent", fields: [sectionId], references: [id])
  question  question @relation("MarksObtainedOnQuestion", fields: [questionId], references: [id])
  @@unique([studentId, questionId, sectionId])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model report {
  id        String   @id  @default(uuid())
  name      String
  type      String
  objective Int
  avgMarks  Float
  studentsAboveRequiredPercentage Int

  questions questionReport[] @relation("QuestionWiseStats")

  testId    String
  courseId  String
  sectionId String?
  programId String?
  section   section? @relation(fields: [sectionId], references: [id])
  program   program? @relation(fields: [programId], references: [id])
  test      test @relation(fields: [testId], references: [id])
  course    course @relation(fields: [courseId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model questionReport {
  id        String   @id  @default(uuid())
  avgMarks  Float
  studentsAttempted Int
  studentsPassed Int
  studentsFailed Int

  questionId String
  reportId   String
  question   question @relation("QuestionReport", fields: [questionId], references: [id])
  report     report @relation("QuestionWiseStats", fields: [reportId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}